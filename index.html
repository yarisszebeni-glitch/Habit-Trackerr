<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Habit Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial;
  background:#f2f2f2;
  margin:0;
  padding:20px;
  overflow-x:hidden;
}
.container{
  max-width:1200px;
  margin:auto;
  background:#fff;
  border-radius:12px;
  padding:20px;
}

/* ===== TABS ===== */
.tabs{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
.tabs button{
  padding:6px 10px;
  border-radius:6px;
  border:none;
  background:#ddd;
  cursor:pointer;
}
.tabs button.active{
  background:#6fa85c;
  color:#fff;
}

/* ===== TABLE ===== */
.tableWrapper{overflow-x:auto}
table{
  border-collapse:collapse;
  width:100%;
  font-size:12px;
  min-width:900px;
}
th,td{
  border:1px solid #ddd;
  padding:4px;
  text-align:center;
}
th{background:#f7f7f7}
.habit{text-align:left;font-weight:bold}
.delete{color:red;cursor:pointer}

.progress{
  height:8px;
  background:#ddd;
  border-radius:6px;
  overflow:hidden;
  margin-top:4px;
}
.progress div{
  height:100%;
  background:#6fa85c;
}
.empty{background:#fafafa}

/* ===== CHART ===== */
.chartWrapper{
  height:320px;
  margin-top:30px;
}
@media(max-width:768px){
  .chartWrapper{height:220px}
}

/* ===== WEEK VIEW ===== */
#weekView{display:none}
.weekNav{
  display:flex;
  justify-content:space-between;
  margin:10px 0;
}
.weekCards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:12px;
}
.weekCard{
  background:#6fa85c;
  color:white;
  border-radius:12px;
  padding:12px;
}
.weekCard h4{margin:0}
.circle{
  width:80px;
  height:80px;
  border-radius:50%;
  background:conic-gradient(#fff var(--deg),rgba(255,255,255,.3) 0);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  color:#2f5d25;
  margin:8px auto;
}
.weekTask{
  display:flex;
  gap:6px;
  align-items:center;
  font-size:13px;
}
  .statBtn{
  position:absolute;
  top:10px;
  right:10px;
  border:none;
  background:white;
  color:#2f5d25;
  border-radius:6px;
  cursor:pointer;
  font-size:12px;
  padding:3px 6px;
}
.sleepInfo{
  margin-top:6px;
  font-size:12px;
  opacity:.9;
}
.weekCard{position:relative}

</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div class="container">

<h2>Habit Tracker</h2>

<div id="userStatus">Nicht eingeloggt</div>
<button id="loginBtn">Login mit Google</button>
<button id="logoutBtn">Logout</button>

<hr>

<div class="tabs">
  <button id="monthTab" class="active">Monat</button>
  <button id="weekTab">Woche</button>
  <button id="statsTab">Statistik</button>
</div>


<b>Jahr:</b>
<select id="yearSelect"></select>

<div class="tabs" id="months"></div>

<br>
<input id="habitInput" placeholder="Neuer Habit">
<input id="goalInput" type="number" placeholder="Ziel (Tage)">
<button onclick="addHabit()">Hinzuf√ºgen</button>

<br><br>

<!-- ===== MONAT ===== -->
<div id="monthView">
  <div class="tableWrapper">
    <table id="table"></table>
  </div>
  <div class="chartWrapper">
    <canvas id="monthChart"></canvas>
  </div>
</div>

<!-- ===== WOCHE ===== -->
<div id="weekView">
 <div class="weekNav">
  <button onclick="changeWeek(-1)">‚Üê Woche</button>
<button onclick="currentWeekOffset=0;renderWeek()">Aktuelle Woche</button>

  <button onclick="changeWeek(1)">Woche ‚Üí</button>
</div>

  <div class="weekCards" id="weekCards"></div>
</div>
<!-- ===== STATISTIK ===== -->
<div id="statsView" style="display:none">
<div class="weekNav">
  <button onclick="changeStats(-1)">‚Üê</button>

  <button onclick="setStatsMode('week')">Woche</button>

  <span id="statsTitle"></span>

  <button onclick="setStatsMode('month')">Monat</button>

  <button onclick="changeStats(1)">‚Üí</button>
</div>



  <p><b>√ò Schlaf:</b> <span id="avgSleep">‚Äì</span> h</p>
  <p><b>Fehlender Schlaf:</b> <span id="missingSleep">‚Äì</span> h</p>

  <canvas id="sleepChart" style="margin-top:20px"></canvas>
</div>


</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyCkWCxlVJGoNbXG7jHQ-KKgRrKtamQb6B0",
  authDomain:"habit-tracker-71caa.firebaseapp.com",
  projectId:"habit-tracker-71caa",
  storageBucket:"habit-tracker-71caa.appspot.com",
  messagingSenderId:"512623329438",
  appId:"1:512623329438:web:b678351963b85e17d23b8f"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const provider=new GoogleAuthProvider();

/* ================= LOGIN ================= */
loginBtn.onclick=()=>signInWithPopup(auth,provider);
logoutBtn.onclick=()=>signOut(auth);

/* ================= DATA ================= */
let data={
  habits:{},
  logs:{},
  sleep:{}   // Struktur: sleep[y][m][d] = { night: number, nap: number }

};
// üîß Sicherheits-Fix f√ºr bestehende User
data.sleep ??= {};

let currentYear=new Date().getFullYear();
let currentMonth=new Date().getMonth();
let chart;
let currentWeekOffset=0;
  // ===== Statistik-Status =====
let statsMode = "week";   // "week" oder "month"
let statsOffset = 0;


const weekDays=['Mo','Di','Mi','Do','Fr','Sa','So'];
const monthNames=['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
function timeToHours(str){
  if(!str.includes(":")) return null;
  let [h,m] = str.split(":").map(Number);
  if(isNaN(h) || isNaN(m) || m < 0 || m >= 60) return null;
  return h + m / 60;
}

function hoursToTime(num){
  let h = Math.floor(num);
  let m = Math.round((num - h) * 60);
  return `${h}:${m.toString().padStart(2,"0")}`;
}
 

/* ================= AUTH ================= */
onAuthStateChanged(auth,async user=>{
  if(!user){
    userStatus.textContent="Nicht eingeloggt";
    return;
  }
  userStatus.textContent="Eingeloggt als: "+user.email;
  const snap=await getDoc(doc(db,"users",user.uid));
 if(snap.exists()){
  data=snap.data();
  data.sleep ??= {};   // üîß WICHTIG
}else{
  await setDoc(doc(db,"users",user.uid),data);
}

  renderMonth();
  renderWeek();
});

/* ================= HELPERS ================= */
  window.renderSleepStats = function(){
    let title = "";

  const TARGET = 8;

  let arr = [];
  let labels = [];

  if(statsMode === "week"){
   let base = new Date();
base.setDate(base.getDate() + statsOffset * 7);

let start = new Date(base);
start.setDate(start.getDate() - start.getDay() + 1);

let end = new Date(start);
end.setDate(start.getDate() + 6);

title = `${start.toLocaleDateString()} ‚Äì ${end.toLocaleDateString()}`;


    for(let d=0; d<7; d++){
      let date = new Date(start);
      date.setDate(start.getDate() + d);

      let y = date.getFullYear();
      let m = date.getMonth();
      let i = date.getDate() - 1;

      let v = data.sleep?.[y]?.[m]?.[i];
      if(typeof v === "number"){
        arr.push(v);
        labels.push(["Mo","Di","Mi","Do","Fr","Sa","So"][d]);
      }
    }
  }

if(statsMode === "month"){
  let base = new Date();
  base.setMonth(base.getMonth() + statsOffset);

  let y = base.getFullYear();
  let m = base.getMonth();
  let days = new Date(y, m+1, 0).getDate();

  title = `${monthNames[m]} ${y}`;

  for(let i=0;i<days;i++){
   let s = data.sleep?.[y]?.[m]?.[i];
if(s && typeof s === "object"){
  let total = (s.night || 0) + (s.nap || 0);
  arr.push(total);

      labels.push(i+1);
    }
  }
}

  if(arr.length === 0) return;


  // √ò Schlaf
  let avg = (arr.reduce((a,b)=>a+b,0) / arr.length).toFixed(1);
  avgSleep.textContent = hoursToTime(parseFloat(avg));


  let targetTotal = arr.length * TARGET;
let actualTotal = arr.reduce((a,b)=>a+b,0);
let missing = targetTotal - actualTotal;

missingSleep.textContent =
  missing > 0 ? hoursToTime(missing) : "0:00";


  // Titel (Datum / Zeitraum anzeigen)
  statsTitle.textContent = title;

  // Chart
  if(window.sleepChartObj) window.sleepChartObj.destroy();
  window.sleepChartObj = new Chart(sleepChart,{
    type:"line",
    data:{
      labels: labels,
      datasets:[
        {
          data: arr,
          borderWidth:2,
          tension:.3
        },
        {
  data: Array(arr.length).fill(TARGET),
          borderDash:[5,5],
          borderWidth:1
        }
      ]
    },
    options:{
      scales:{ y:{ min:0, max:12 }},
      plugins:{ legend:{ display:false }}
    }
  });
}

function daysInMonth(y,m){return new Date(y,m+1,0).getDate();}
async function save(){
  if(!auth.currentUser) return;
  await setDoc(doc(db,"users",auth.currentUser.uid),data);
}

/* ================= INIT ================= */
for(let y=currentYear-3;y<=currentYear+3;y++){
  let o=document.createElement("option");
  o.value=y;o.textContent=y;
  if(y===currentYear)o.selected=true;
  yearSelect.appendChild(o);
}
yearSelect.onchange=()=>{currentYear=+yearSelect.value;renderMonth();};

monthNames.forEach((m,i)=>{
  let b=document.createElement("button");
  b.textContent=m;
  if(i===currentMonth)b.classList.add("active");
  b.onclick=()=>{
    currentMonth=i;
    document.querySelectorAll("#months button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    renderMonth();
  };
  months.appendChild(b);
});

/* ================= HABITS ================= */
window.addHabit=()=>{
  let n=habitInput.value.trim();
  if(!n||data.habits[n])return;
  data.habits[n]=parseInt(goalInput.value)||30;
  habitInput.value="";goalInput.value="";
  save();renderMonth();renderWeek();
};
window.deleteHabit=(n)=>{
  if(!confirm("L√∂schen?"))return;
  delete data.habits[n];
  for(let y in data.logs)for(let m in data.logs[y])delete data.logs[y][m][n];
  save();renderMonth();renderWeek();
};
window.toggle=(h,i)=>{
  data.logs[currentYear]??={};
  data.logs[currentYear][currentMonth]??={};
  data.logs[currentYear][currentMonth][h][i]=!data.logs[currentYear][currentMonth][h][i];
  save();renderMonth();renderWeek();
};

/* ================= MONAT ================= */
function renderMonth(){
  const days=daysInMonth(currentYear,currentMonth);
  const weeks=Math.ceil(days/7);

  data.logs[currentYear]??={};
  data.logs[currentYear][currentMonth]??={};
  for(let h in data.habits)
    data.logs[currentYear][currentMonth][h]??=Array(days).fill(false);

  table.innerHTML="";
  let h1=`<tr><th rowspan="2">Habit</th><th rowspan="2">%</th><th rowspan="2">‚úñ</th>`;
  for(let w=1;w<=weeks;w++)h1+=`<th colspan="7">Woche ${w}</th>`;
  h1+="</tr>";

  let h2="<tr>";
  for(let i=0;i<weeks*7;i++){
    let d=i+1<=days?i+1:"";
    let wd=i<days?weekDays[(new Date(currentYear,currentMonth,i+1).getDay()+6)%7]:"";
    h2+=`<th>${wd}<br>${d}</th>`;
  }
  h2+="</tr>";
  table.innerHTML+=h1+h2;

  let habits=data.logs[currentYear][currentMonth];
  for(let h in habits){
    let done=habits[h].filter(v=>v).length;
    let p=Math.round(done/data.habits[h]*100)||0;
    let row=`<tr><td class="habit">${h}<div class="progress"><div style="width:${p}%"></div></div></td>
      <td>${p}%</td><td class="delete" onclick="deleteHabit('${h}')">‚úñ</td>`;
    for(let i=0;i<weeks*7;i++){
      if(i<days)row+=`<td><input type="checkbox" ${habits[h][i]?"checked":""} onclick="toggle('${h}',${i})"></td>`;
      else row+=`<td class="empty"></td>`;
    }
    row+="</tr>";
    table.innerHTML+=row;
  }
  renderChart(habits,days);
}

/* ================= WEEK ================= */
function renderWeek(){
  weekCards.innerHTML="";
  const start=new Date();
  start.setDate(start.getDate()-start.getDay()+1+(currentWeekOffset*7));

  for(let d=0;d<7;d++){
    let date=new Date(start);
    date.setDate(start.getDate()+d);

    let y=date.getFullYear(),m=date.getMonth(),i=date.getDate()-1;
    data.logs[y]??={};
    data.logs[y][m]??={};
    data.sleep[y] ??= {};
data.sleep[y][m] ??= {};
let sleepVal=data.sleep[y][m][i];

    

    let habits=data.logs[y][m];
for(let h in data.habits){
  habits[h] ??= Array(daysInMonth(y,m)).fill(false);
}

    let names=Object.keys(data.habits);
    let done=0;
    names.forEach(h=>{if(habits[h]?.[i])done++;});
    let p=names.length?Math.round(done/names.length*100):0;

    let card=document.createElement("div");
    card.className="weekCard";
    card.innerHTML=`
  <button class="statBtn" onclick="editSleep(${y},${m},${i})">üìä</button>
  <h4>${weekDays[d]}</h4>
  <small>${date.toLocaleDateString()}</small>
  <div class="circle" style="--deg:${p*3.6}deg">${p}%</div>
<div class="sleepInfo">
  üåô ${sleepVal?.night !== undefined ? hoursToTime(sleepVal.night) : "‚Äì"}
  <br>
  ‚òÄÔ∏è ${sleepVal?.nap ? hoursToTime(sleepVal.nap) : "0:00"}
  <br>
  <b>Œ£ ${sleepVal ? hoursToTime((sleepVal.night||0)+(sleepVal.nap||0)) : "‚Äì"}</b>
</div>


`;

    names.forEach(h=>{
      habits[h]??=Array(daysInMonth(y,m)).fill(false);
      card.innerHTML+=`<div class="weekTask">
        <input type="checkbox" ${habits[h][i]?"checked":""} onchange="toggle('${h}',${i})">
        <span>${h}</span></div>`;
    });
    weekCards.appendChild(card);
  }
}
window.changeWeek = (d) => {
  currentWeekOffset += d;

  if(weekView.style.display === "block"){
    renderWeek();
  }
};

window.changeStats = (d)=>{
  statsOffset += d;
  renderSleepStats();
};
window.setStatsMode = function(mode){
  statsMode = mode;
  statsOffset = 0;
  renderSleepStats();
};


window.editSleep = (y,m,d)=>{
  let nightStr = prompt("Nachtschlaf eingeben (hh:mm), z. B. 6:30");
  if(nightStr === null) return;

  let night = timeToHours(nightStr);
  if(night === null || night < 0 || night > 24){
    alert("Ung√ºltiger Nachtschlaf");
    return;
  }

  let napStr = prompt("Mittagsschlaf eingeben (hh:mm) oder leer lassen", "0:00");
  if(napStr === null) return;

  let nap = timeToHours(napStr);
  if(nap === null || nap < 0 || nap > 10){
    alert("Ung√ºltiger Mittagsschlaf");
    return;
  }

  data.sleep[y] ??= {};
  data.sleep[y][m] ??= {};
  data.sleep[y][m][d] = {
    night,
    nap
  };

  save();
  renderWeek();
};

  
window.setStatsMode = function(mode){
  statsMode = mode;
  statsOffset = 0;
  renderSleepStats();
};

window.changeStats = function(dir){
  statsOffset += dir;
  renderSleepStats();
};


/* ================= CHART ================= */
function renderChart(habits,days){
  let done=Array(days).fill(0),tot=Array(days).fill(0);
  for(let h in habits)habits[h].forEach((v,i)=>{tot[i]++;if(v)done[i]++;});
  let perc=done.map((v,i)=>tot[i]?Math.round(v/tot[i]*100):0);
  if(chart)chart.destroy();
  chart=new Chart(monthChart,{type:"line",data:{labels:[...Array(days).keys()].map(i=>i+1),
    datasets:[{data:perc,fill:true,tension:.3}]},
    options:{responsive:true,scales:{y:{min:0,max:100}},plugins:{legend:{display:false}}}});
}
window.changeStatsPeriod = function(dir){
  statsOffset += dir;
  renderSleepStats();
};


/* ===== VIEW SWITCH ===== */
 

monthTab.onclick=()=>{
  monthTab.classList.add("active");
  weekTab.classList.remove("active");
  statsTab.classList.remove("active");

  monthView.style.display="block";
  weekView.style.display="none";
  statsView.style.display="none";
};

 statsTab.onclick=()=>{
  statsTab.classList.add("active");
  monthTab.classList.remove("active");
  weekTab.classList.remove("active");

  monthView.style.display="none";
  weekView.style.display="none";
  statsView.style.display="block";

  statsMode = "week";
statsOffset = 0;



renderSleepStats();

};


weekTab.onclick=()=>{
  weekTab.classList.add("active");
  monthTab.classList.remove("active");
  statsTab.classList.remove("active");

  monthView.style.display="none";
  weekView.style.display="block";
  statsView.style.display="none";

  renderWeek();
};

</script>
</body>
</html> 

































